@model List<Pronia.Models.Product>

<style>
    .table { table-layout: fixed; width: 100%; }
    .truncate-text { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .actions-column { width: 160px; white-space: nowrap; }
</style>

<div class="container mt-4">
    <h2>Products</h2>
    <a asp-action="Create" class="btn btn-success mb-3">Create New Product</a>

    @Html.AntiForgeryToken()

    <table class="table table-bordered table-striped">
        <thead>
        <tr>
            <th style="width: 50px;">Id</th>
            <th style="width: 150px;">Name</th>
            <th>Description</th>
            <th style="width: 80px;">Price</th>
            <th style="width: 90px;">Image</th>
            <th style="width: 120px;">Category</th>
            <th class="actions-column">Actions</th>
        </tr>
        </thead>
        <tbody>
        @foreach(var product in Model)
        {
        <tr>
            <td>@product.Id</td>
            <td class="truncate-text" title="@product.Name">@product.Name</td>
            <td class="truncate-text" title="@product.Description">@product.Description</td>
            <td>@product.Price ₼</td>
            <td>
                <img src="@product.ImagePath"
                     style="width:70px; height:70px; object-fit: cover; border-radius: 5px;"
                     onerror="this.onerror=null;this.src='/assets/images/no-image.png';" />
            </td>
            <td>@product.Category?.Name</td>
            <td class="actions-column">
                <a asp-action="Update" asp-route-id="@product.Id" class="btn btn-warning btn-sm">Edit</a>
                <button type="button" onclick="deleteProduct(@product.Id)" class="btn btn-danger btn-sm">Delete</button>
            </td>
        </tr>
        }
        </tbody>
    </table>
</div>

@* Подключаем напрямую, чтобы не зависеть от секций *@
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    function deleteProduct(id) {
        Swal.fire({
            title: "Are you sure?",
            text: "This product and its image will be deleted forever!",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: "Yes, delete it!"
        }).then((result) => {
            if (result.isConfirmed) {
                const token = document.querySelector('input[name="__RequestVerificationToken"]').value;

                fetch(`/Admin/Product/Delete/${id}`, {
                    method: 'POST',
                    headers: {
                        "RequestVerificationToken": token
                    }
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            Swal.fire("Deleted!", "Product has been removed.", "success")
                                .then(() => location.reload());
                        } else {
                            Swal.fire("Error!", data.message || "Something went wrong.", "error");
                        }
                    })
                    .catch(err => {
                        Swal.fire("Error!", "Server communication failed.", "error");
                    });
            }
        });
    }
</script>